# L7 互联网络

## 分类

- OCN: On Chip Network
- SAN: System Area Network
- LAN: Local Area Network
- WAN: Wide Area Network

## 拓扑

### 拓扑分类

- 直接型（每个路由关联一个终端）
- 间接型（路由节点区别于终端）

按照交换拓扑分类：
- 总线型
- 交叉开关型

### 静态网络

静态网络由点—点直接相连而成,这种连结方式在程序
执行过程中不会改变。

#### 环

![](_v_images/20200507110557848_79664825.png)

- 双向环：链路数为N,直径「N/2」,度为2,对称,等分宽度为2。
- 单向环：链路数为N,直径N-1,度为2,对称,等分宽度为2。

##### 带弦环

![](_v_images/20200507110723598_1505039445.png)

##### 全连接网络

全连接网络是带弦环的一种特殊情形。全连接网络中的每个结点和其他结点之间都有单一的直接链路

##### 循环移数网络结构

将环上每一个结点与其距离为2的整次幂的结点连接起来

![](_v_images/20200507111317439_387271585.png)

若网络规模N=$2^n$, 则网络连接度d=2n-1,网络直径D=n/2。

#### 树形

![](_v_images/20200507111914585_141532400.png)

一棵k层完全二叉树有N = $2^k-1$个结点,结点度为3,直径为2(k - 1)(即右边任意一个叶子结点到左边任意一个叶子结点)。不对称,等分度为1。

#### 星形

星形实际上是一种二层树

![](_v_images/20200507112315044_764999293.png)

#### 网格和环网格

![](_v_images/20200507113213508_1299562238.png)

有N个结点的r*r网，有2N - 2r条链路, 直径为2(r-1),结点度为4,非对称,等分宽度为r

##### IIIiac网

![](_v_images/20200507113305612_1023977981.png)

有2N 条链路,直径为r-1,结点度为4。

#### 其他

- 2d环
- 超立方体
- 环形网

### 动态网络

网络的开关元件有源,可通过设置这些开关的状态来重构链路。

大多数动态网络是多级互连网络

多级互连网络三要素：
- 开关单元
- 级间互连模式
- 控制方式

输入和输出的连接方式可以用置换表示。置换方式可以用互连函数表示：

- 恒等函数
- 方体函数
- 洗牌函数：循环左移一位。变体：超洗牌，子洗牌，逆洗牌……
- 蝶式：最高位与最低位交换
- PM2I

多级互连网络：
- 多立方体结构
- Omega网络

## 路由

TODO

## 流控

数据分为：
- 消息
- 数据包
- 数据片
- 物理层传输单位

不同的流控技术基于不同的粒度

### 基于消息的流控

在多跳之间预分配资源

探针建立线路后消息不需要在网络的每一跳进行路由和资源分配  有利于传输大规模的数据

在传输完成前,其他消息不能使用这些资源

### 基于数据包的流控

链路上数据包是交错的

每个节点需要缓存来存储正在传输的数据包

两种相关技术：

#### 存储转发

头数据片会在路由器等待，在完整的数据包都接收之后,发送至下一跳

导致高延迟(每一跳都存在串行延迟)

#### 虚拟直通

在尾数据片被当前路由器接收之前,头数据片就可以发送至下一跳

缓存空间不足影响吞吐量

### 基于数据片的流控

当缓存空间足够缓存该数据片时,即可发送至下一个路由器

#### 虫孔流控

链路利用率低: 如果头数据片阻塞了, 所有用于
该数据包的链路都变成空闲

#### 虚拟通道

每个输入端口有多个数据片队列。共享同一个物理链路（时分复用）

### 包冲突解决方法

当两个包到达同一个结点时,可能请求同一个接收缓冲区或用同一个输出通道

#### 包缓冲

将通道分给一个包，其他包放进缓冲区

需要一个能存放整个包的缓冲区,包缓冲区不可能做在寻径芯片上,要用存储器作为缓冲区,会有较大的存储延迟

#### 包阻塞

第二个包被阻塞不再前进,但没有被扬弃

#### 扬弃并重发

第二个包被扬弃

#### 阻塞后绕道

第二个包绕道:被转发到其它的寻径器

### 死锁避免

使用流控技术保证无死锁,可以获得灵活的路由

对虚拟通道强制规定顺序

逃逸虚拟通道：
- 在潜在的循环中,为每个数据包提供一个逃逸路径 
- 有一个虚拟通道使用无死锁路由子函数
- 数据包总能有机会落到逃逸虚拟通道上
- 一旦在逃逸虚拟通道上,必须停留在那里

### 虚拟通道重分配

一个虚拟通道什么时候可以被重分配给一个新
的数据包

两种选择: 保守的和激进的
- 保守的 (原子的): 只重分配空的虚拟通道
- 激进的 (非原子的): 收到尾数据片即进行重分配

通常使用非原子虚拟通道分配

### 缓存背压

需要机制避免缓存溢出

上游节点需要知道下游路由器的缓存使用情况

#### 基于信用的流控

上游路由器存储下游虚拟通道的信用值

当数据片向前移动，信用值减少

下游路由器数据片前进并且缓存清空时，发送信用，上游增加信用值

**往返信用延迟**: 缓存项清空和该缓存项中下一个数据片可以发送这两者间的时间

#### On-Off流控

使用开关信号控制上游发送信号

关信号：当空闲缓存数量低于阈值时发送

开信号：当空闲缓存数量高于阈值时发送