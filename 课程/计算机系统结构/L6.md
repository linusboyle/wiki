# L6 动态调度

ILP，指令级并行: 指指令之间存在的一种并行性,利用它计算机可以并行执行两条或两条以上的指令。

两种开发方法：
- 静态调度
- 动态调度

## 乱序执行

指令的执行顺序与程序顺序不相同。指令的完成也是乱序完成的

为支持乱序执行，将译码阶段分为**流出**和**读操作数**两个阶段。
- 流出：指令译码,检查是否存在结构冲突
- 读操作数：等待数据冲突消失,然后读操作数。

乱序执行导致**写后读**和**写后写**冲突成为可能

同时，异常处理较为复杂。可能产生**不精确异常**。

> **不精确异常**：当执行指令i导致发生异常时,处理机的现场(状态)与严格按程序顺序执行时指令i的现场不同。

## 动态调度技术

### 记分牌

使用记录控制器集中记录各功能部件、流水线中各指令、源和目的REG的状态(记分牌),然后进行统一调度
![](_v_images/20200409113859763_2125180250.png)

有冲突则推后进入，进入后有相关则进入后推后执行。

- 发射/流出阶段：检查记分牌，等待，解决控制相关和WAW。**注意**：发射如果暂停，不发射后面的指令
- 读操作数阶段：等待，解决RAW
- WB阶段：等待，解决WAR

记分牌的结构：

- 每个正在执行的指令状态（阶段）
- 每个功能部件的状态：
    - 空闲位
    - 该部件执行的操作类型
    - 目的寄存器编号
    - 源寄存器编号
    - 产生源操作器中操作数的部件
    - 记录源寄存器中的数据是否就绪，是否被取走
- 每个寄存器的结果状态：指示是哪个功能部件对该寄存器进行写操作

### Tomasulo算法

使用重命名技术解决两类名称冲突（WAW和WAR）；以及分布式动态调度技术将状态记录和控制分散到各个功能部件中

功能单元中有一系列RS：
- OP code
- Vj&vk：源操作数的值
- Qj&Qk：产生源操作数的RS
- BUSY位
- A：立即数

此时算法有三个阶段：
- 发射：只要FU还有空闲的RS就发射。发射后，分配RS，并依据寄存器状态填入操作数，或者设置等待
- 执行：检查RAW，等俩个操作数就绪就执行。
- 写：通过总线，把结果传给等待此结果的RS。