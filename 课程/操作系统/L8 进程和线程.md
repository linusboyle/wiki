# L8 进程和线程

## 进程

### 进程的概念

进程：具有一定独立功能的程序在一个数据集合上的一次动态执行过程。 进程包含了正在运行的一个程序的所有状态信息。

特点：
- 动态
- 并发
- 独立
- 制约（访问共享数据，进程间同步）

### 进程控制块 PCB

操作系统管理进程运行所用信息的集合。每个进程在OS对应一个PCB。

- 标识信息
- 现场保存
- 控制信息：
    + 调度信息
    + 通信信息
    + 存储管理信息
    + 进程所用资源
    + 有关数据结构连接信息

PCB的组织：可以使用链表。就绪链表，阻塞链表等。

### 进程的状态

- 创建
- 执行
- 等待
- 抢占
- 唤醒
- 结束

### 三状态进程模型

就绪、运行、等待

### 挂起进程模型

挂起：进程从内存转到外存
激活：进程从外存转到内存

处于挂起状态的进程映像在磁盘上，以减少进程占用内存。

- 等待->等待挂起
- 就绪->就绪挂起
- 运行->就绪挂起

![](_v_images/20200316102826038_1594367472.png)

OS维护状态队列，表示不同状态。

## 线程

进程内部的一类实体
- 实体之间可以并发执行
- 实体之间共享存储空间

### 线程的概念

线程是进程的一部分，它是进程中指令流的最小单元，是CPU调度的基本单位。线程有独立的寄存器和堆栈。

### 用户线程

在用户空间实现。每个进程有私有TCB列表，无需核心态切换，允许进程有自己的线程调度算法。

缺点：
- 不支持基于线程的处理机抢占，只能依赖线程主动放弃CPU。
- 线程发起syscall时整个进程阻塞。

### 内核线程

由内核通过syscall实现线程，维护TCB。

创建、终止和切换开销更大

#### 轻权进程

进程可有多个轻量级进程，每个轻权进程对应一个内核线程，以及多个用户线程。

## 进程控制

### 进程切换

暂停当前进程，调度另一个就绪进程。 切换前，保存进程上下文；切换后，恢复进程上下文。

将相同状态的进程PCB放在同一队列里。

### 进程创建

fork()创建一个继承的子进程。复制所有内存。子进程返回0，父进程返回子进程pid。

### 进程加载

exec完成加载

### 进程等待和退出

wait用于父进程等待子进程的结束。子进程结束时通过exit向父进程返回一个值

有两种情况：
- 父进程先wait，则父进程进入等待状态。当子进程exit时，唤醒父进程，将exit参数作为父进程wait的返回值。
- 子进程先exit，变成僵尸子进程，则wait立刻返回其中一个值；无子进程存活时，直接返回。