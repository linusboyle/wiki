# L9 调度

- 从就绪队列挑选下一个占用CPU运行的进程。
- 从多个可用CPU挑选就绪进程可用的CPU资源

## 调度时机

- 进程从运行状态切换到等待状态
- 进程终结
- 非抢占系统：进程主动放弃CPU
- 可抢占系统：中断请求响应完成/被抢占
    - 时间片用完
    - 进程从等待切换到就绪

## 调度策略

### 比较调度算法的指标

- CPU使用率
- 吞吐量（单位时间完成的进程数量）
- 周转时间
- 等待时间
- 响应时间

### 调度算法

#### 先来先服务算法

依据进程进入就绪状态的先后顺序排列。

#### 短进程优先算法

选择就绪队列中执行时间最短进程占用CPU。 就绪队列按照**预期**的执行时间排序。

可以达到最优周转时间，但是可能导致饥饿（长进程无法获得CPU），需要预知运行时间。

变种：短剩余运行时间优先（考虑剩余运行时间，如果新进程预期时间比当前剩余时间短，允许抢占）

使用历史执行时间预估：

![](_v_images/20200323091846570_759406646.png)

#### 最高响应比优先

![](_v_images/20200323091944840_1919838423.png)

基于SPN，不可抢占

#### 时间片轮转算法（Round Robin）

**时间片**：分配处理机资源的基本时间单元

RR算法开销：额外的上下文切换

#### 多级反馈队列算法

**多级队列算法ML**：就绪队列被划分为多个独立的子队列。每个队列拥有自己的调度策略。

队列间调度：
- 固定优先级
- 时间片轮转

优化：**多级反馈队列算法MLFQ**

- 优先级越大，时间片越小
- 如果进程在当前时间片没有完成，则降到下一个优先级

#### 公平共享调度算法

一些用户组比其他用户组更重要

## 实时调度

周期实时任务指标：
- 周期
- 执行时间
- 使用率

* 硬时限：必须在最坏情况下能够满足时限
* 软时限：通常能满足任务时限；不满足则能降级

**可调度性**：实时操作系统能够满足任务时限要求。

需要确定实时任务的执行顺序
- 静态优先级调度
- 动态优先级调度

### 速率单调调度算法RM

根据周期安排优先级，周期越短优先级越高。

### 最早截止时间优先EDF

截止时间越早优先级越高

## 多处理机调度

### 处理器架构

- 超线程
- 单核处理器/多核处理器/众核处理器

多处理器系统典型结构：
- 对称多处理系统Large SMP：通过总线连接所有核与主存
- 非一致内存访问系统NUMA：组内通过总线直接连接一部分主存，组间通过Router连接

其它：Cache一致性……

### 多处理器调度概述

- 单队列多处理器调度（SQMS）：共享一个队列。由于需要同步进行读写，可扩展性差。缓存亲和性弱。
- 多队列多处理器调度（MQMS）：多个调度队列，每个队列可使用不同的调度规则，进程创建时将其放入某队列之中。CPU间独立调度。 MQMS**负载不均**，解决方法：**迁移**

如何发起迁移——**工作窃取**：

进程较少的队列不定期地查看其他队列是否比自己进程多，如果其显著更满，就从目标队列「窃取」一个或多个进程。

对称多处理器调度：
- 每个处理器有自己的调度程序
- 调度程序对共享资源的访问需要同步

### 进程分配

- 静态进程分配：进程分配到一个固定的处理器。处理器有自己的队列。
- 动态进程分配：所有处理器共享一个队列，进程可在执行中切换处理器。

### O(1)调度

每个CPU都有Active和Expire两种队列。每种队列一共140个优先级，用长度为140的bitarray去记录；每个优先级下用FIFO队列管理这个优先级的进程，新来的进程插到队尾，先进先出。

在active队列(APA)里寻找left-most bit的位置，找到相应的队列，从中弹出一个进程。

当进程执行完毕，重新计算其优先级并插入到expire队列（EPA）对应的队里，并相应置bitarray中 的bit位。

如果active bitarray全为零，将其和expire bitarray交换。

一定时间后，进行负载平衡分析。

### CFS调度

通过计算进程消耗的 CPU 时间(标准化以后的虚拟 CPU 时间)来确定谁来调度。从而到达所谓的公平性。

根据权重分配运行时间，分配给进程的运行时间 = 调度周期 * 进程权重 / 所有进程权重之和。调度周期是将所有处于*TASK_RUNNING*态进程都调度一遍的时间

实现中，引入虚拟运行时间vruntime = 实际运行时间 * 1024 / 进程权重。vruntime最小的进程将被调度。采用红黑树记录进程的vruntime。

权重如何计算：通过nice值查表。

每个CPU的运行队列都维护一个最小vruntime。这样，当新进程进入此队列时，初始vruntime就取这个最小值（防止饿死老进程）；休眠进程唤醒时也按照最小vruntime，加上一定的补偿。

当进程从一个CPU的队列中出来，其vruntime减去队列的最小vruntime。进入另一个队列时，又加上这个队列的最小vruntime。

### BFS调度

单队列，记录线程虚拟结束时间和优先级

## 优先级反置

**优先级反置**指 操作系统中出现高优先级进程长时间等待低优先级进程所占用的资源的现象。

基于优先级的可抢占调度算法都存在此问题。

### 优先级继承

高优先级进程申请低优先级占用的资源时，使得低优先级进程继承高优先级进程的优先级。

*只在低优先级进程阻塞时，才提高其优先级*

### 优先级天花板协议

占用资源的进程的优先级和所有可能申请此资源的进程的最高优先级相同。