# 时钟

## 当前的实现

widget为默认时钟，每个同步周期都会取相关事件、更新语义值。

因为程序是单入口的，程序员可以在其他结点上实现时钟相关的逻辑，而只把control节点用作接口。直观上，增加widget时钟功能不会增加多少新功能。

一种场景：有一值A作组件W的时钟，希望只有A成立的周期才取W的事件，并更新W的参数。存在的问题：

1. A的值是在下一个周期计算的，而W的事件值是程序入口传入的。如果要实现，就必须在W传入之前计算出A的值。目前的结构不适合。
2.  控制代码生成是和后端独立的，控制部分并不知道A。

## 一种设计
在META  变量之后允许when x标记时钟，x可以是当前作用域里的符号。这里的when x是给控制代码生成用的，用来控制输入输出。META本身对应的实际变量是参数和返回值，其时钟还是默认的（或者是按照widget声明里的时钟关系）。这种时钟关系由Lustre处理，when指定的时钟关系由控制代码生成步骤处理。

假设能确认widget实例的所有元变量都有相同的时钟声明，那么问题就剩下如何确定x的值。
一种非常复杂的做法：先拓扑排序，将计算x的块提取为新的节点，这个节点返回x在这一点的值以及所有后面要用到的变量的值。然后控制代码用x的值判断是否需要取w的事件，然后将w的事件传入之后的计算节点。。。。
不太实际。